amends "pkl/velocity.pkl"
import "pkl/prebuilts/git.pkl"
import "pkl/prebuilts/build.pkl"

tests {
    new {
        name = "Golang tests"
        commands {
            git.clone
            // build.create("Test") // uncomment to get invalid build error
            new ShellCommand {
                command = "go test ./..."
            }
        }
    }
}

runtimes {
    new DockerRuntime {
        name = "golang"
        image = "golang:1.21"
    }
}

workflows {
    new {
        name = "Golang tests"
        groups {
            new {
                name = "Golang tests"
                runtimes {
                    "golang"
                    // "python" // Uncomment to get invalid runtime error
                }
                tests {
                    "Golang tests"
                    // "non" // uncomment to get invalid test error
                }
            }
        }
    }
}

builds {
    new {
        name = "CLI"
        build_runtime = "golang"
        output = "dist/velocity"

        output_runtime = "golang"
        output_command = "velocity"

        commands {
            git.clone
            new ShellCommand {
                command = "make build-cli"
            }
        }
    }
}

deployments {
    new {
        name = "CLI"
        runtime = "golang"

        workflows {
            "Golang tests"
            // "invalid" // uncomment to get invalid workflow error
        }

        commands {
            build.create("CLI") 
            // build.create("tests")  // uncomment to get invalid build error

        }
    }
}